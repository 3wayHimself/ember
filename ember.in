#!/bin/bash



# Function to find the real directory a program resides in.
# Feb. 17, 2000 - Sam Lantinga, Loki Entertainment Software
FindPath()
{
    fullpath="`echo $0 | grep /`"
    if [ "$fullpath" = "" ]; then
        oIFS="$IFS"
        IFS=:
        for path in $PATH
        do if [ -x "$path/$0" ]; then
               if [ "$path" = "" ]; then
                   path="."
               fi
               fullpath="$path/$0"
               break
           fi
        done
        IFS="$oIFS"
    fi
    if [ "$fullpath" = "" ]; then
        fullpath="$0"
    fi
 
    # Is the sed/ls magic portable?
    if [ -L "$fullpath" ]; then
        #fullpath="`ls -l "$fullpath" | awk '{print $01}'`"
        fullpath=`ls -l "$fullpath" |sed -e 's/.* -> //' |sed -e 's/\*//'`
    fi
    dirname $fullpath
}





# Setup variables

#get the dir where this script resides in
path=`FindPath`
test=${path[0]}
#if [ "$fullpath" = "" ]; then
if [ "$test" = "." ]; then
	path=${PWD}
fi
prefix=${path}/..

echo "According to my calculations Ember should be installed in $prefix"

exec_prefix=${prefix}
bindir=${exec_prefix}/bin
datadir=${prefix}/share/games/ember
etcdir=${prefix}/etc/ember
homedata=$HOME/.ember

WFUT_JAR=$datadir/WFUT.jar
MEDIA_CHANNEL="ember-media-@VERSION@"
SERVER=http://amber.worldforge.org/WFUT/

# Create dir if required 
if [ ! -d $homedata ] ; then
	echo "Created ~/.ember to store all game data."
	mkdir $homedata
fi

# Determine if java executable exists in path
JAVA=`which java`;
if [ $JAVA ] ; then

    # Update
    echo "Updating data from the server, this might take some time on a slow connection (circa 30 Mb of data)"
    XTERM=`which xterm`
	if [ $XTERM ] ; then
    	xterm -T "Downloading media..." -DserverRoot=$SERVER -e $JAVA -jar $WFUT_JAR dest ~/.ember/ update $MEDIA_CHANNEL
    else
    	$JAVA -DserverRoot=$SERVER -jar $WFUT_JAR dest ~/.ember/ update $MEDIA_CHANNEL
    fi
else
  echo "Java not found in path. Updater cannot be run. For now, that means that you won't get the media necessary, so I will quit right now. In the future this dependecy on java will disappear though."
  exit
fi

LD_LIBRARY=$prefix/lib/ember:$LD_LIBRARY
LD_LIBRARY_PATH=$prefix/lib/ember:$LD_LIBRARY_PATH
export LD_LIBRARY
export LD_LIBRARY_PATH

# Execute real ember binary
echo "Starting Ember...."
#we have to do the LD_PRELOAD thing, because else at least I get an error: libnvidia-tls.so.1: cannot handle TLS data /ehj
LD_PRELOAD=libGL.so.1 $bindir/ember.bin --binrelocloading

